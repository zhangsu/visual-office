(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g={}.hasOwnProperty,y=function(e,t){function n(){this.constructor=e}for(var r in t)g.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};l=!1,r={nothing:0,addingSelf:1,removingSelf:2,addingDesk:3,removingDesk:4},m=r.nothing,f="Playground",a={topLeft:{x:-10,y:-10},bottomRight:{x:20,y:10}},c=null,v={},$.ajaxSetup({dataType:"json"}),u=function(e){if(e.status==="ERROR")return alert(e.content)},s=function(t,n){var r,i,s;return i=""+t,s=""+n,r=v[i][s],v[i]&&(v[i][s]=null),r instanceof e?$.post("/user",{x:t,y:n,map_id:f,action:"remove"},u):$.post("/desk",{x:t,y:n,map_id:f,action:"remove"},u)},p=function(t,n,r,i){var s;i==null&&(i=!1),s=""+t,v[s]||(v[s]={}),v[s][""+n]=r;if(!i)return;return r instanceof e?$.post("/user",{x:t,y:n,map_id:f},u):$.post("/desk",{x:t,y:n,map_id:f},u)},o=function(e,t){var n,r;return n=""+e,r=""+t,v[n]?v[n][r]:null},d=function(e,t){var n;return n=a.topLeft,[Math.floor(e/32)+n.x,Math.floor(t/32)+n.y]},h=function(){return $.get("/desks",{map_id:f},function(e){var n,r,i,s,o;u(e),s=e.content,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(new t(n.x,n.y));return o}),$.get("/users",{map_id:f},function(t){var n,r,i,s,a;u(t),s=t.content,a=[];for(r=0,i=s.length;r<i;r++)n=s[r],o(n.x,n.y)?a.push(void 0):a.push(new e(n.id,n.x,n.y));return a})},n=function(){function e(e,t,n){this.x=e,this.y=t,this.height=n}return e.prototype.screenX=function(){return(this.x-a.topLeft.x)*32},e.prototype.screenY=function(){return(this.y-a.topLeft.y+1)*32-this.height},e.prototype.freeTileNode=function(){return s(this.x,this.y)},e.prototype.remove=function(){return this.freeTileNode(),this.jq.addClass("fade-out"),this.jq.bind("animationnend oAnimationEnd webkitAnimationEnd",function(){return $(this).remove()})},e}(),e=function(e){function t(e,n,r,i,s,o){var u;this.name=e,i==null&&(i=!1),this.width=s!=null?s:32,o==null&&(o=48),t.__super__.constructor.call(this,n,r,o),this.orien=0,this.jq=$("<div class='character fade-in'>"),this.jq.css("z-index",r+1e6),this.jq_sprite=$("<div class='sprite'>"),this.jq_sprite.width(this.width),this.jq_sprite.height(o),this.jq.append("<div class='name'>"+this.name+"</div>"),this.jq.append(this.jq_sprite),this.jq_sprite.addClass("male"),this.updateScreenX(),this.updateScreenY(),p(this.x,this.y,this,i),$("#canvas").append(this.jq),u=$(".character:last-child > .name"),u.css("left",""+(this.width-u.width())/2+"px"),u.css("top","-16px")}return y(t,e),t.prototype.enableTurning=function(){var e=this;return this.jq_sprite.click(function(){return e.turn()})},t.prototype.updateScreenX=function(){return this.jq.css("left",""+this.screenX()+"px")},t.prototype.updateScreenY=function(){return this.jq.css("top",""+this.screenY()+"px")},t.prototype.updateOrientation=function(){return this.jq_sprite.removeClass("orien0 orien1 orien2 orien3"),this.jq_sprite.addClass("orien"+this.orien)},t}(n),t=function(e){function t(e,n,r,i){r==null&&(r=!1),i==null&&(i=48),t.__super__.constructor.call(this,e,n,i),this.jq=$("<div class='desk fade-in'>"),this.jq.width(32),this.jq.height(i),this.jq.css("z-index",n+1e6),this.updateScreenPos(),p(this.x,this.y,this,r),$("#canvas").append(this.jq)}return y(t,e),t.prototype.updateScreenPos=function(){return this.jq.css("left",""+this.screenX()+"px"),this.jq.css("top",""+this.screenY()+"px")},t}(n),i=function(){return a.topLeft.y-=10},$(function(){var n,i,s,f,p;return i=$("#canvas"),i.width((a.bottomRight.x-a.topLeft.x)*32),i.height((a.bottomRight.y-a.topLeft.y)*32),f=function(){return l=!1},$(window).focus(f).blur(f).mouseup(f),p=$("#toolbar"),$("#toolbar-toggle").click(function(){return p.toggleClass("collapsed")}),n=function(e,t){return $(e).click(function(){var n;return $(this).toggleClass("pressed"),n=r[t],m===n?m=r.nothing:($("#toolbar>:not("+e+")").removeClass("pressed"),m=n)})},n("#add-self","addingSelf"),n("#remove-self","removingSelf"),n("#add-desk","addingDesk"),n("#remove-desk","removingDesk"),s=function(n){var i,s,u,a;i=d(n.pageX,n.pageY),u=i[0],a=i[1],s=o(u,a);switch(m){case r.addingSelf:if(!s)return c&&c.remove(),c=new e(c.name,u,a,!0),c.enableTurning();break;case r.removingSelf:if(s&&s===c)return s.remove(),m=r.nothing,$("#remove-self").removeClass("pressed");break;case r.addingDesk:if(!s)return new t(u,a,!0);break;case r.removingDesk:if(s instanceof t)return s.remove()}},i.mousedown(function(e){if(e.which===1)return l=!0,s(e)}).mousemove(function(e){if(!l)return;return s(e)}),$.get("/me",function(t){var n;return u(t),n=t.content,c=new e(n.id,n.x,n.y)}),h()})}).call(this);